name: CI

on: 
  push:
  schedule:
    - cron: '0 9 15 * *'  # 每月15号的9点UTC触发工作流

jobs:
  build-logos:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential fakeroot rsync curl perl unzip git ca-certificates
          if ! dpkg -s libtinfo5 > /dev/null 2>&1; then
            sudo apt-get install -y libtinfo-dev
          fi
          
      - name: Setup environment
        run: echo "THEOS=${{ github.workspace }}/theos" >> $GITHUB_ENV

      - name: Download Theos
        run: |
          if [ ! -d "${{ github.workspace }}/theos" ]; then
            git clone --recursive https://github.com/theos/theos.git ${{ github.workspace }}/theos
            echo "Theos successfully downloaded."
          else
            echo "Theos already cached."
          fi
          
      - name: Get toolchain (Linux)
        run: |
          if [[ -d "${{ github.workspace }}/theos/toolchain" && "$(ls -A ${{ github.workspace }}/theos/toolchain)" ]]; then
            echo "Linux toolchain already cached, skipping..."
          else
            TMP_DL=$(mktemp -d)
            wget --no-verbose https://github.com/kabiroberai/swift-toolchain-linux/releases/download/v2.3.0/swift-5.8-ubuntu22.04.tar.xz -P $TMP_DL
            mkdir -p ${{ github.workspace }}/theos/toolchain
            tar -xvf $TMP_DL/swift-5.8-ubuntu22.04.tar.xz -C ${{ github.workspace }}/theos/toolchain
            rm -Rf $TMP_DL
          fi
          
      - name: Get SDKs
        run: |
          if [[ -d "${{ github.workspace }}/theos/sdks" && "$(ls -A ${{ github.workspace }}/theos/sdks)" ]]; then
            echo "Theos SDKs already cached, skipping..."
          else
            cd ${{ github.workspace }}/theos/sdks
            wget --no-verbose https://github.com/theos/sdks/archive/master.zip
            unzip -o master.zip
            mv sdks-master/*.sdk ./
            rm -r master.zip sdks-master
          fi
